<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>Workout Timer</title>
</head>
<body>
    <p id="clock"></p>
    <form>
        <input id="time" type="number" name="time" step="0.1"> minutes
        <input type="submit" value="GO">
    </form>
    <audio id="alarm" src="alarm.mp3" muted="" loop="" autoplay=""></audio>
    <button id="stop" style="display: none;">Stop</button>
    <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function(e) {
            let time = 0;

            function done() {
                document.getElementById('clock').innerHTML = "DONE";
                document.getElementById('alarm').muted = false;
                document.getElementById('stop').style.display = "block";
            }

            function speak(value, volume = 1) {
                const synth = window.speechSynthesis;
                const voices = synth.getVoices();
                let voice;
                voices.forEach(function(v) {
                    if (v.lang.toLowerCase() === 'zh-hk') {
                        voice = v;
                    }
                    if (voice === null && v.lang.toLowerCase() === 'en-us') {
                        voice = v;
                    }
                });
                setTimeout(function() {
                    let utterThis = new SpeechSynthesisUtterance(value);
                    utterThis.voice = voice;
                    utterThis.pitch = 1.2;
                    utterThis.rate = 0.8;
                    utterThis.volume = volume;
                    synth.speak(utterThis);
                }, 0);
            }

            function countdown() {
                let x = setInterval(function() {
                    time -= 1;
                    document.getElementById('clock').innerHTML = time + " second";
                    if (time < 0) {
                        clearInterval(x);
                        done();
                    }
                    if ((time % 10 === 0 || time <= 5) && time > 0) {
                        speak(time);
                    }
                }, 1000);
            }

            speak('1');

            const form = document.querySelector('form');
            const inputTxt = document.getElementById('time');
            const stopBtn = document.getElementById('stop');
            stopBtn.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('alarm').muted = true;
            });
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                document.getElementById('alarm').muted = true;
                time = inputTxt.value * 60;
                countdown();
            }, false);
        }, false);
    </script>
</body>
</html>
